<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Performance Advisor</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f1419;--surface:#1a2028;--surface2:#232b35;
  --text:#e6e8eb;--muted:#8b949e;--border:#30363d;
  --accent:#58a6ff;--success:#3fb950;--warn:#e3b341;--danger:#f85149;
  --critical-bg:rgba(248,81,73,.12);--high-bg:rgba(227,179,65,.12);
  --medium-bg:rgba(88,166,255,.12);--low-bg:rgba(139,148,158,.12);
}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
a{color:var(--accent)}
header{text-align:center;padding:2rem 1rem 1rem;border-bottom:1px solid var(--border)}
header h1{font-size:1.5rem;font-weight:600}
header p{color:var(--muted);font-size:.875rem;margin-top:.25rem}
main{max-width:960px;margin:0 auto;padding:1.5rem 1rem 3rem}

/* Input section */
.input-area{display:flex;flex-direction:column;gap:.75rem}
textarea{width:100%;height:200px;background:var(--surface);color:var(--text);
  border:1px solid var(--border);border-radius:6px;padding:.75rem;
  font-family:"SFMono-Regular",Consolas,monospace;font-size:.8rem;resize:vertical}
textarea:focus{outline:none;border-color:var(--accent)}
textarea::placeholder{color:var(--muted)}
.actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;align-items:center;gap:.375rem;padding:.5rem 1rem;
  border:1px solid var(--border);border-radius:6px;background:var(--surface);
  color:var(--text);font-size:.875rem;cursor:pointer;font-weight:500;transition:background .15s}
.btn:hover{background:var(--surface2)}
.btn-primary{background:var(--accent);color:#0f1419;border-color:var(--accent)}
.btn-primary:hover{opacity:.9;background:var(--accent)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed}
.file-label{cursor:pointer}
.file-label input[type=file]{display:none}
.or{color:var(--muted);font-size:.8rem}

/* Loading */
.loading{text-align:center;padding:3rem 0;display:none}
.loading.active{display:block}
.spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .8s linear infinite;margin:0 auto .75rem}
@keyframes spin{to{transform:rotate(360deg)}}

/* Error */
.error-msg{background:var(--critical-bg);border:1px solid var(--danger);border-radius:6px;
  padding:.75rem 1rem;color:var(--danger);font-size:.875rem;margin-top:1rem;display:none}
.error-msg.active{display:block}

/* Results */
.results{display:none;margin-top:1.5rem}
.results.active{display:block}

/* Score card */
.score-card{display:flex;align-items:center;gap:2rem;background:var(--surface);
  border:1px solid var(--border);border-radius:8px;padding:1.5rem;margin-bottom:1rem}
.score-gauge{flex-shrink:0}
.score-info{flex:1}
.score-info h2{font-size:1.125rem;font-weight:600;margin-bottom:.25rem}
.meta-row{display:flex;gap:1.5rem;flex-wrap:wrap;color:var(--muted);font-size:.8rem}
.meta-item{display:flex;align-items:center;gap:.25rem}
.meta-val{color:var(--text);font-weight:600}
.result-actions{display:flex;gap:.5rem;margin-bottom:1.25rem;flex-wrap:wrap}

/* Severity groups */
.severity-group{margin-bottom:1.25rem}
.severity-group-header{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;
  padding-bottom:.375rem;border-bottom:1px solid var(--border)}
.severity-group-header h3{font-size:.9rem;font-weight:600}
.group-count{background:var(--surface2);color:var(--muted);font-size:.75rem;
  padding:.125rem .5rem;border-radius:10px}

/* Finding cards */
.finding{background:var(--surface);border:1px solid var(--border);border-radius:6px;
  margin-bottom:.5rem;overflow:hidden;border-left:3px solid var(--border)}
.finding.sev-critical{border-left-color:var(--danger)}
.finding.sev-high{border-left-color:var(--warn)}
.finding.sev-medium{border-left-color:var(--accent)}
.finding.sev-low{border-left-color:var(--muted)}
.finding-header{display:flex;align-items:flex-start;gap:.5rem;padding:.625rem .75rem;
  cursor:pointer;user-select:none}
.finding-header:hover{background:var(--surface2)}
.badge{font-size:.7rem;font-weight:600;padding:.125rem .5rem;border-radius:10px;
  text-transform:uppercase;letter-spacing:.025em}
.badge-critical{background:var(--critical-bg);color:var(--danger)}
.badge-high{background:var(--high-bg);color:var(--warn)}
.badge-medium{background:var(--medium-bg);color:var(--accent)}
.badge-low{background:var(--low-bg);color:var(--muted)}
.rule-id{font-size:.7rem;font-family:monospace;min-width:2.25rem;text-align:center;
  background:var(--surface2);color:var(--muted);padding:.125rem .375rem;border-radius:4px;
  font-weight:600;flex-shrink:0;margin-top:.0625rem}
.finding-center{flex:1;min-width:0}
.finding-title{font-size:.875rem;font-weight:600}
.finding-panels-preview{font-size:.75rem;color:var(--accent);margin-top:.1875rem;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.finding-why-preview{font-size:.75rem;color:var(--muted);margin-top:.125rem;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.finding-tags{display:flex;align-items:center;gap:.375rem;flex-shrink:0;margin-top:.0625rem}
.autofix-badge{font-size:.65rem;color:var(--success);border:1px solid var(--success);
  padding:.0625rem .375rem;border-radius:8px;white-space:nowrap}
.occurrence-count{color:var(--muted);font-size:.75rem;white-space:nowrap}
.chevron{color:var(--muted);font-size:.75rem;transition:transform .15s;margin-top:.0625rem}
.finding.open .chevron{transform:rotate(90deg)}
.finding-body{display:none;padding:.5rem .75rem .75rem;border-top:1px solid var(--border);
  font-size:.825rem;color:var(--muted)}
.finding.open .finding-body{display:block}
.field{margin-bottom:.375rem}
.field strong{color:var(--text);font-weight:500}
.panels-list{color:var(--accent);font-size:.8rem}

/* Score gauge SVG */
.gauge-text{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}

/* Cardinality badge */
.cardinality-badge{font-size:.7rem;padding:.125rem .5rem;border-radius:10px;font-weight:600}
.cardinality-badge.enriched{background:rgba(63,185,80,.15);color:var(--success)}
.cardinality-badge.heuristic{background:var(--low-bg);color:var(--muted)}

/* Confidence indicator */
.confidence{font-size:.65rem;color:var(--muted);white-space:nowrap}
.confidence-dot{display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:3px;vertical-align:middle}
.confidence-dot.high{background:var(--success)}
.confidence-dot.medium{background:var(--warn)}
.confidence-dot.low{background:var(--muted)}

/* Top expensive queries */
.expensive-queries{background:var(--surface);border:1px solid var(--border);border-radius:8px;
  padding:1rem 1.25rem;margin-bottom:1.25rem}
.expensive-queries h3{font-size:.9rem;font-weight:600;margin-bottom:.625rem}
.eq-row{display:flex;align-items:baseline;gap:.75rem;padding:.25rem 0;
  border-bottom:1px solid var(--border);font-size:.8rem}
.eq-row:last-child{border-bottom:none}
.eq-rank{color:var(--muted);min-width:1.25rem;text-align:right;flex-shrink:0}
.eq-cost{color:var(--warn);font-weight:600;font-family:monospace;min-width:5rem;
  text-align:right;flex-shrink:0}
.eq-expr{color:var(--text);font-family:monospace;overflow:hidden;text-overflow:ellipsis;
  white-space:nowrap;flex:1;min-width:0}

/* Responsive */
@media(max-width:600px){
  .score-card{flex-direction:column;text-align:center}
  .meta-row{justify-content:center}
}
</style>
</head>
<body>
<header>
  <h1>Dashboard Performance Advisor</h1>
  <p>Analyze Grafana dashboards for performance anti-patterns</p>
</header>
<main>
  <section class="input-area" id="input-section">
    <textarea id="json-input" placeholder="Paste Grafana dashboard JSON here..."></textarea>
    <div class="actions">
      <label class="btn file-label">
        <input type="file" id="file-input" accept=".json">
        Upload JSON
      </label>
      <span class="or">or paste above, then</span>
      <button class="btn btn-primary" id="analyze-btn" onclick="analyze()">Analyze</button>
    </div>
  </section>

  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="color:var(--muted)">Analyzing dashboard...</p>
  </div>

  <div class="error-msg" id="error"></div>

  <section class="results" id="results">
    <div class="score-card">
      <div class="score-gauge" id="score-gauge"></div>
      <div class="score-info">
        <h2 id="dash-title"></h2>
        <div class="meta-row">
          <div class="meta-item">Panels: <span class="meta-val" id="m-panels"></span></div>
          <div class="meta-item">Targets: <span class="meta-val" id="m-targets"></span></div>
          <div class="meta-item">Issues: <span class="meta-val" id="m-issues"></span></div>
          <div class="meta-item">Parse errors: <span class="meta-val" id="m-errors"></span></div>
          <span class="cardinality-badge" id="m-cardinality"></span>
        </div>
      </div>
    </div>
    <div class="result-actions">
      <button class="btn btn-primary" id="fix-btn" onclick="applyFixes()">Apply Auto-Fixes &amp; Download</button>
      <button class="btn" onclick="reset()">Analyze Another</button>
    </div>
    <div class="expensive-queries" id="expensive-queries" style="display:none">
      <h3>Top Expensive Queries (by estimated cost)</h3>
      <div id="eq-list"></div>
    </div>
    <div id="findings-list"></div>
  </section>
</main>

<script>
const SEVERITY_NAMES = ['Low', 'Medium', 'High', 'Critical'];
const SEVERITY_CLASSES = ['low', 'medium', 'high', 'critical'];
const SEVERITY_ORDER = [3, 2, 1, 0]; // Critical first

let currentJSON = '';

document.getElementById('file-input').addEventListener('change', function(e) {
  var file = e.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(ev) {
    document.getElementById('json-input').value = ev.target.result;
  };
  reader.readAsText(file);
});

// Allow Ctrl+Enter to trigger analyze
document.getElementById('json-input').addEventListener('keydown', function(e) {
  if (e.ctrlKey && e.key === 'Enter') analyze();
});

function showLoading() {
  document.getElementById('loading').classList.add('active');
  document.getElementById('error').classList.remove('active');
  document.getElementById('results').classList.remove('active');
  document.getElementById('analyze-btn').disabled = true;
}

function hideLoading() {
  document.getElementById('loading').classList.remove('active');
  document.getElementById('analyze-btn').disabled = false;
}

function showError(msg) {
  hideLoading();
  var el = document.getElementById('error');
  el.textContent = msg;
  el.classList.add('active');
}

function reset() {
  document.getElementById('json-input').value = '';
  document.getElementById('results').classList.remove('active');
  document.getElementById('error').classList.remove('active');
  currentJSON = '';
}

async function analyze() {
  var input = document.getElementById('json-input').value.trim();
  if (!input) return;

  // Validate JSON
  try { JSON.parse(input); } catch(e) {
    showError('Invalid JSON: ' + e.message);
    return;
  }
  currentJSON = input;
  showLoading();

  try {
    var resp = await fetch('/api/analyze', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: input
    });
    if (!resp.ok) {
      var errText = await resp.text();
      throw new Error(errText);
    }
    var report = await resp.json();
    renderResults(report);
  } catch(e) {
    showError('Analysis failed: ' + e.message);
  }
}

function renderResults(report) {
  hideLoading();

  document.getElementById('dash-title').textContent =
    (report.DashboardTitle || 'Untitled') + ' (' + (report.DashboardUID || '?') + ')';
  document.getElementById('m-panels').textContent = report.Metadata.TotalPanels;
  document.getElementById('m-targets').textContent = report.Metadata.TotalTargets;
  document.getElementById('m-issues').textContent = report.Findings ? report.Findings.length : 0;
  document.getElementById('m-errors').textContent = report.Metadata.ParseErrors;

  renderScoreGauge(report.Score);

  // Cardinality badge
  var cardBadge = document.getElementById('m-cardinality');
  if (report.Metadata.cardinalityAvailable) {
    cardBadge.textContent = 'enriched (live TSDB)';
    cardBadge.className = 'cardinality-badge enriched';
  } else {
    cardBadge.textContent = 'heuristic';
    cardBadge.className = 'cardinality-badge heuristic';
  }

  // Top expensive queries
  renderExpensiveQueries(report.Metadata.queryCosts);

  var hasAutoFixable = report.Findings && report.Findings.some(function(f){ return f.AutoFixable; });
  document.getElementById('fix-btn').style.display = hasAutoFixable ? '' : 'none';

  renderFindings(report.Findings || []);
  document.getElementById('results').classList.add('active');
}

function renderScoreGauge(score) {
  var color = score >= 80 ? '#3fb950' : score >= 60 ? '#58a6ff' : score >= 40 ? '#e3b341' : '#f85149';
  var label = score >= 80 ? 'GOOD' : score >= 60 ? 'FAIR' : score >= 40 ? 'POOR' : 'CRITICAL';

  // SVG semicircular gauge
  var radius = 52, stroke = 8, cx = 64, cy = 60;
  var circumference = Math.PI * radius;
  var progress = circumference * (score / 100);

  var svg = '<svg width="128" height="80" viewBox="0 0 128 80">'
    + '<path d="M ' + (cx - radius) + ' ' + cy + ' A ' + radius + ' ' + radius + ' 0 0 1 ' + (cx + radius) + ' ' + cy + '"'
    + ' fill="none" stroke="' + 'var(--border)' + '" stroke-width="' + stroke + '" stroke-linecap="round"/>'
    + '<path d="M ' + (cx - radius) + ' ' + cy + ' A ' + radius + ' ' + radius + ' 0 0 1 ' + (cx + radius) + ' ' + cy + '"'
    + ' fill="none" stroke="' + color + '" stroke-width="' + stroke + '" stroke-linecap="round"'
    + ' stroke-dasharray="' + progress + ' ' + circumference + '"/>'
    + '<text x="' + cx + '" y="' + (cy - 10) + '" text-anchor="middle" fill="' + color + '"'
    + ' font-size="28" font-weight="700" class="gauge-text">' + score + '</text>'
    + '<text x="' + cx + '" y="' + (cy + 6) + '" text-anchor="middle" fill="' + 'var(--muted)' + '"'
    + ' font-size="10" font-weight="500" class="gauge-text">' + label + '</text>'
    + '</svg>';

  document.getElementById('score-gauge').innerHTML = svg;
}

function renderFindings(findings) {
  var container = document.getElementById('findings-list');
  container.innerHTML = '';

  // Group by severity (descending)
  var groups = {};
  findings.forEach(function(f) {
    var sev = f.Severity;
    if (!groups[sev]) groups[sev] = [];
    groups[sev].push(f);
  });

  // Deduplicate findings by RuleID within each severity group
  // (the engine may return one Finding per occurrence for some rules)
  // Display grouped by rule
  SEVERITY_ORDER.forEach(function(sev) {
    var items = groups[sev];
    if (!items || items.length === 0) return;

    var sevName = SEVERITY_NAMES[sev];
    var sevClass = SEVERITY_CLASSES[sev];

    var groupDiv = document.createElement('div');
    groupDiv.className = 'severity-group';

    var header = document.createElement('div');
    header.className = 'severity-group-header';
    header.innerHTML = '<span class="badge badge-' + sevClass + '">' + sevName + '</span>'
      + '<h3>' + sevName + ' Issues</h3>'
      + '<span class="group-count">' + items.length + '</span>';
    groupDiv.appendChild(header);

    // Group items by RuleID
    var byRule = {};
    items.forEach(function(f) {
      if (!byRule[f.RuleID]) byRule[f.RuleID] = [];
      byRule[f.RuleID].push(f);
    });

    Object.keys(byRule).forEach(function(ruleID) {
      var ruleFindings = byRule[ruleID];
      var first = ruleFindings[0];
      var totalOccurrences = ruleFindings.length;

      // Collect all affected panels
      var allPanels = [];
      ruleFindings.forEach(function(f) {
        if (f.PanelTitles) {
          f.PanelTitles.forEach(function(t) {
            if (allPanels.indexOf(t) === -1) allPanels.push(t);
          });
        }
      });

      var card = document.createElement('div');
      card.className = 'finding sev-' + sevClass;

      var hdr = document.createElement('div');
      hdr.className = 'finding-header';
      hdr.onclick = function() { card.classList.toggle('open'); };

      var occText = totalOccurrences > 1 ? totalOccurrences + 'x' : '';
      var ruleTooltip = ruleID.charAt(0) === 'Q' ? 'PromQL query rule' : ruleID.charAt(0) === 'D' ? 'Dashboard design rule' : 'Backend rule';

      // Panel names preview (collapsed header)
      var panelPreview = '';
      if (allPanels.length > 0) {
        var previewPanels = allPanels.slice(0, 2);
        var extraCount = allPanels.length > 2 ? ' +' + (allPanels.length - 2) + ' more' : '';
        panelPreview = '<div class="finding-panels-preview">' + esc(previewPanels.join(', ')) + extraCount + '</div>';
      }

      // Why preview (collapsed header)
      var whyPreview = first.Why ? '<div class="finding-why-preview">' + esc(first.Why) + '</div>' : '';

      hdr.innerHTML = '<span class="rule-id" title="' + esc(ruleTooltip) + '">' + esc(ruleID) + '</span>'
        + '<div class="finding-center">'
        +   '<div class="finding-title">' + esc(first.Title) + '</div>'
        +   panelPreview
        +   whyPreview
        + '</div>'
        + '<div class="finding-tags">'
        +   (first.AutoFixable ? '<span class="autofix-badge">auto-fix</span>' : '')
        +   confidenceHtml(first.Confidence)
        +   (occText ? '<span class="occurrence-count">' + occText + '</span>' : '')
        + '</div>'
        + '<span class="chevron">&#9654;</span>';
      card.appendChild(hdr);

      var body = document.createElement('div');
      body.className = 'finding-body';

      var html = '';
      if (allPanels.length > 0) {
        var shown = allPanels.slice(0, 5);
        var extra = allPanels.length > 5 ? ' (+' + (allPanels.length - 5) + ' more)' : '';
        html += '<div class="field panels-list">Panels: ' + esc(shown.join(', ')) + extra + '</div>';
      }
      html += '<div class="field"><strong>Why:</strong> ' + esc(first.Why) + '</div>';
      html += '<div class="field"><strong>Fix:</strong> ' + esc(first.Fix) + '</div>';
      html += '<div class="field"><strong>Impact:</strong> ' + esc(first.Impact) + '</div>';
      if (first.Validate) {
        html += '<div class="field"><strong>Validate:</strong> ' + esc(first.Validate) + '</div>';
      }
      body.innerHTML = html;
      card.appendChild(body);
      groupDiv.appendChild(card);
    });

    container.appendChild(groupDiv);
  });
}

async function applyFixes() {
  if (!currentJSON) return;
  var btn = document.getElementById('fix-btn');
  btn.disabled = true;
  btn.textContent = 'Applying...';

  try {
    var resp = await fetch('/api/fix', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: currentJSON
    });
    if (!resp.ok) throw new Error(await resp.text());
    var result = await resp.json();

    // Trigger download
    var jsonStr = JSON.stringify(result.dashboard, null, 2);
    var blob = new Blob([jsonStr], {type: 'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'dashboard-fixed.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);

    btn.textContent = 'Downloaded! (' + result.fixCount + ' fixes applied)';
    setTimeout(function() {
      btn.textContent = 'Apply Auto-Fixes & Download';
      btn.disabled = false;
    }, 3000);
  } catch(e) {
    showError('Fix failed: ' + e.message);
    btn.textContent = 'Apply Auto-Fixes & Download';
    btn.disabled = false;
  }
}

function renderExpensiveQueries(queryCosts) {
  var container = document.getElementById('expensive-queries');
  var list = document.getElementById('eq-list');
  list.innerHTML = '';

  if (!queryCosts || Object.keys(queryCosts).length === 0) {
    container.style.display = 'none';
    return;
  }

  // Sort by cost descending, take top 5
  var entries = Object.entries(queryCosts).sort(function(a, b) { return b[1] - a[1]; });
  var top = entries.slice(0, 5);

  top.forEach(function(entry, i) {
    var expr = entry[0];
    var cost = entry[1];
    var row = document.createElement('div');
    row.className = 'eq-row';
    row.innerHTML = '<span class="eq-rank">' + (i + 1) + '.</span>'
      + '<span class="eq-cost">' + formatCost(cost) + '</span>'
      + '<span class="eq-expr" title="' + esc(expr) + '">' + esc(expr) + '</span>';
    list.appendChild(row);
  });

  container.style.display = '';
}

function formatCost(n) {
  if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
  if (n >= 1000) return (n / 1000).toFixed(0) + 'k';
  return '' + n;
}

function confidenceHtml(confidence) {
  if (confidence === undefined || confidence === null) return '';
  var level = confidence >= 0.8 ? 'high' : confidence >= 0.5 ? 'medium' : 'low';
  var pct = Math.round(confidence * 100);
  var tip = level === 'high' ? 'High confidence — detection is based on deterministic checks'
          : level === 'medium' ? 'Moderate confidence — based on heuristics; live TSDB data would improve accuracy'
          : 'Low confidence — requires live Prometheus data to confirm (use --prometheus-url)';
  return '<span class="confidence" title="' + tip + '"><span class="confidence-dot ' + level + '"></span>' + pct + '%</span>';
}

function esc(s) {
  if (!s) return '';
  var d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
