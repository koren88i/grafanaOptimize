services:
  exporter:
    build:
      context: .
      dockerfile: Dockerfile.exporter
    ports:
      - "9099:9099"

  prometheus:
    image: prom/prometheus:v2.51.0
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.min-block-duration=2h"
      - "--storage.tsdb.max-block-duration=2h"
      - "--web.enable-lifecycle"
    volumes:
      - ./demo/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    depends_on:
      - exporter

  thanos-sidecar:
    image: quay.io/thanos/thanos:v0.34.1
    command:
      - sidecar
      - "--tsdb.path=/prometheus"
      - "--prometheus.url=http://prometheus:9090"
      - "--grpc-address=0.0.0.0:10901"
    volumes:
      - prometheus-data:/prometheus:ro
    depends_on:
      - prometheus

  thanos-querier:
    image: quay.io/thanos/thanos:v0.34.1
    command:
      - query
      - "--http-address=0.0.0.0:9090"
      - "--grpc-address=0.0.0.0:10902"
      - "--store=thanos-sidecar:10901"
    ports:
      - "10902:9090"
    depends_on:
      - thanos-sidecar

  thanos-query-frontend:
    image: quay.io/thanos/thanos:v0.34.1
    command:
      - query-frontend
      - "--http-address=0.0.0.0:9090"
      - "--query-frontend.downstream-url=http://thanos-querier:9090"
      - "--query-frontend.log-queries-longer-than=5s"
    ports:
      - "10903:9090"
    profiles:
      - optimized
    depends_on:
      - thanos-querier

  grafana:
    image: grafana/grafana:10.4.2
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - ./demo/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./demo/dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - thanos-querier

volumes:
  prometheus-data:
